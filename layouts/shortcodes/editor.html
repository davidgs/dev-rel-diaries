<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<style>
  .custom-file-input.selected:lang(en)::after {
    content: "" !important;
  }

  .custom-file {
    overflow: hidden;
  }

  .custom-file-input {
    white-space: nowrap;
  }

  .pill {
    font-size: 12px;
    font-family: "Readex Pro", sans-serif;
    padding: 5px 10px;
    padding-right: 25px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    margin-right: 5px;
    margin-left: -1px;
    margin-bottom: 5px;
    border-radius: 100px;
    font-size: 14px;
    border: none;
    outline: none;
    background: #dddddd;
    cursor: pointer;
  }

  .pill:not(.pill--selected):hover {
    background: #cccccc;
  }

  .pill--selected {
    background: #009578;
    color: #ffffff;
  }

  .pill--purple {
    font-size: 12px;
    font-family: "Readex Pro", sans-serif;
    padding: 5px 10px;
    padding-right: 25px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    margin-right: 5px;
    margin-left: -1px;
    margin-bottom: 5px;
    border-radius: 100px;
    font-size: 14px;
    border: none;
    outline: none;
    cursor: pointer;
    background: linear-gradient(135deg, #4235d0 38%, #f969cd 100%);
    color: #ffffff;
  }

  .close {
    position: relative;
    right: 10px;
    top: 7px;
    width: 6px;
    height: 6px;
    opacity: 1;
    z-index: 99;
    cursor: pointer;
  }

  .close:hover {
    opacity: 0.3;
  }

  .close:before,
  .close:after {
    position: absolute;
    left: 20px;
    content: ' ';
    height: 8px;
    width: 2px;
    background-color: #ffffff;
    cursor: pointer;
  }

  .close:before {
    transform: rotate(45deg);
  }

  .close:after {
    transform: rotate(-45deg);
  }
</style>
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>

<h2><span class='text-span'>Time</span> to tell your story</h2>
<p><span class='text-span'>Use</span> the form below to create a new story. You can use the editor to format your story
  and add images.</p>
<p><span class='text-span'>These</span> first few fields are mandatory so please fill them out completely.</p>
<form id="storyForm" name="storyForm" class="row g-3 needs-validation" novalidate>
  <div class="form-floating col-md-6">
    <input type="text" class="form-control" id="titleInput" placeholder="The title of your story"
      aria-describedby="titleHelpBlock" required>
    <label for="titleInput">Title</label>
    <div id="titleHelpBlock" class="form-text">
      Give your story a compelling title. This field is required.
    </div>
  </div>
  <div class="form-floating col-md-6">
    <input type="text" class="form-control" id="descriptionInput" placeholder="Describe your story"
      aria-describedby="descriptionHelpBlock" required>
    <label for="descriptionInput">Description</label>
    <div id="descriptionHelpBlock" class="form-text">
      Give your story a brief description. This field is required.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
    <div class="invalid-feedback">
      You must provide a description for your story.
    </div>
  </div>
  <div class="form-floating col-md-12">
    <input type="text" class="form-control" id="nameInput" placeholder="Your name or pseudonym"
      aria-describedby="nameHelpBlock" required>
    <label for="nameInput">Name or Pseudonym</label>
    <div id="nameHelpBlock" class="form-text">
      You do <strong>not</strong> have to supply your real name. Please feel free to use an anonymous pseudonym if you
      wish.
    </div>
    <div class="invalid-feedback">
      You must provide either your real name or a pseudonym before submitting.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
  </div>
  <div class="input-group input-group-lg col-md-12">
      <input type="file" class="form-control" id="customFileInput" placeholder="Choose your Header Image" aria-describedby="imageHelpBlock"
      required onchange=setImage()></input>
    <!--label for="imageInput">Header Image</label -->
    <div id="imageHelpBlock" class="form-text">
      Enter the full URL to an image you'd like to use as the header-image for your story. (We use <a
        href="https://unsplash.com/" target="_blank">Unsplash</a> for our images.)
    </div>
    <div class="invalid-feedback">
      You must provide a header image for your story.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
  </div>
  <div id="image" class="col-md-12"></div>
  <div class="form-floating col-md-12">
    <input type="text" class="form-control" id="tagsInput" placeholder="Tags" aria-describedby="tagsHelpBlock"
      oninput=addPill()>
    <label for="tagsInput">Tags</label -->
    <div id="tagsHelpBlock" class="form-text">
      Enter a comma-separated list of tags for your story. These will be used to help people find your story.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
  </div>
  <div class="form-floating col-md-12" id="tags-div">
  </div>
  <h2><span class='text-span'>Your</span> story</h2>
  <div class="form-floating col-md-12">
    <textarea id="input" required></textarea>
    <div class="invalid-feedback">
      You must provide a story.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
    <div id="storyHeaderHelpBlock" class="form-text">
      Write your story here in Markdown. The browser will autosave the contents for you so you don't have to worry about
      losing your work. When you're happy with your story, click the submit button.
    </div>
  </div>
  <div class="form-floating col-md-12">
    <span class='text-span'>The</span> following fields are <strong>not</strong> required.
    <!--p><span class='text-span'>If</span> you do not wish to provide any of the following information, please leave the
    fields blank.</p -->
  </div>
  <div class="form-floating col-md-6">
    <input type="email" class="form-control" id="emailInput" placeholder="name@example.com"
      aria-describedby="emailHelpBlock">
    <label for="emailInput">Email address</label>
    <div id="emailHelpBlock" class="form-text">
      You do <strong>not</strong> have to supply your email address. If you do, we will never share it with anyone
      else.
    </div>
  </div>
  <div class="form-floating col-md-6">
    <label for="twitterUsername" class="form-label">Twitter Handle</label>
    <div class="input-group has-validation">
      <span class="input-group-text" id="inputGroupPrepend">@</span>
      <input type="text" class="form-control" id="twitterUsername" aria-describedby="twitterUsernameHelpBlock">
      <div id="twitterUsernameHelpBlock" class="form-text">
        You do <strong>not</strong> have to supply your twitter handle. If you do, we will link your submission to
        your
        twitter account.
      </div>
    </div>
  </div>
  <div class="form-floating col-md-12">
    <input type="url" class="form-control" id="webInput" placeholder="Your website" aria-describedby="webHelpBlock">
    <label for="webInput">Your website</label>
    <div id="webHelpBlock" class="form-text">
      You do <strong>not</strong> have to supply this. If you do, we will link your submission back to this address.
    </div>
  </div>
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <div class="form-floating col-md-8">
      <div class="form-check form-check-reverse">
        <input class="form-check-input" type="checkbox" value="getCOC()" id="reverseCheck1" onchange=checkCOC()>
        <label class="form-check-label" for="reverseCheck1">
          I have read and agree to the <a href="/code_of_conduct" target="_blank">Code of Conduct</a> and <a
            href="/privacy_policy" target="_blank">Privacy Policy</a>.
        </label>
        <div class="invalid-feedback">
          You must agree before submitting.
        </div>
        <div class="valid-feedback">
          Looks good!
        </div>
      </div>
    </div>
    <div class="form-floating col-md-2">
      <button id="submitButton" class="btn btn-primary me-md-2" type="submit" disabled>Submit</button>
    </div>
    <div class="form-floating col-md-2">
      <button class="btn btn-danger" type="button" onClick=clearForm()>Clear</button>
    </div>
  </div>
</form>
<script>
  let coc = false;
  const easyMDE = new EasyMDE();

  document.querySelector('.custom-file-input').addEventListener('change', function (e) {
    var name = document.getElementById("customFileInput").files[0].name;
    var nextSibling = e.target.nextElementSibling
    nextSibling.innerText = name
  })

  function setImage(){
    // Get the image file
    const f = document.getElementById("customFileInput").files[0];
    console.log("setImage: " + document.getElementById("customFileInput").files[0]);
    // Create a new FileReader
    const reader = new FileReader();
    // Read the file
    reader.readAsDataURL(f);
    // When it's loaded, set image data as background of div
    reader.onload = function () {
      const d = document.getElementById("image")
      const im = document.createElement("img")
      im.setAttribute("src", `${reader.result}`);
      d.appendChild(im);
    };

  }
  function addPill() {
    const tags = document.getElementById("tagsInput").value;
    console.log(document.getElementById("tagsInput").value);
    if (tags.includes(",")) {
      const tagsArray = tags.split(",");
      const tagsDiv = document.getElementById("tags-div");
      const pill = document.createElement("button");
      pill.classList.add("pill--purple");
      pill.setAttribute("type", "button");
      pill.innerText = tagsArray[0];
      pill.innerHTML += `<span class="close"></span>`;
      tagsDiv.appendChild(pill);
      pill.addEventListener("click", (e) => {
        const p = e.target.parentElement;
        e.currentTarget.remove();
      });
      document.getElementById("tagsInput").value = "";
    }
  }

  function clearForm() {
    easyMDE.value('');
  }
  function onSubmit() {
    console.log("submitting");
  }

  document.getElementById("storyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const forms = document.querySelectorAll('.needs-validation')
    const title = document.getElementById("titleInput").value;
    const description = document.getElementById("descriptionInput").value;
    const image = document.getElementById("imageInput").value;
    const email = document.getElementById("emailInput").value;
    const twitter = document.getElementById("twitterUsername").value;
    const name = document.getElementById("nameInput").value;
    const web = document.getElementById("webInput").value;
    const content = easyMDE.value();
    const data = {
      title: title,
      description: description,
      image: image,
      email: email,
      twitter: twitter,
      name: name,
      web: web,
      content: content
    };
    console.log(data);
    fetch('https://devreldiaries.com:9494/submitStory', { mode: 'cors', method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
      .then(response => response.json())
      .then(data => {
        console.log('Success:', data);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  });

  function checkCOC() {
    if (coc) {
      coc = false;
    } else {
      coc = true;
    }
    console.log(coc);
    if (coc) {
      document.getElementById("submitButton").removeAttribute("disabled");
    } else {
      document.getElementById("submitButton").setAttribute("disabled", "disabled");
    }
  }
</script>