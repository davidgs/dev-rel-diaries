<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<form id="storyForm" name="storyForm" class="row g-3 needs-validation" novalidate>
  <h2 id="storyHeader" aria-describedby="storyHeaderHelpBlock"><span class='text-span'>Your</span> story</h2>
  <div id="storyHeaderHelpBlock" class="form-text">
    Write your story here in Markdown. The browser will autosave the contents for you so you don't have to worry about
    losing your work. When you're happy with your story, click the submit button.
  </div>
  <div class="form-floating col-md-6">
    <input type="text" class="form-control" id="titleInput" placeholder="The title of your story"
      aria-describedby="titleHelpBlock" required>
    <label for="titleInput">Title</label>
    <div id="titleHelpBlock" class="form-text">
      Give your story a compelling title. This field is required.
    </div>
    <div class="invalid-feedback">
      You must provide a title for your story.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
  </div>
  <div class="form-floating col-md-6">
    <input type="text" class="form-control" id="descriptionInput" placeholder="Describe your story"
      aria-describedby="descriptionHelpBlock" required>
    <label for="descriptionInput">Description</label>
    <div id="descriptionHelpBlock" class="form-text">
      Give your story a brief description. This field is required.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
    <div class="invalid-feedback">
      You must provide a description for your story.
    </div>
  </div>
  <div class="form-floating col-md-12">
    <input type="text" class="form-control" id="imageInput" placeholder="Header Image" aria-describedby="imageHelpBlock"
      required>
    <label for="imageInput">Header Image Location</label>
    <div id="imageHelpBlock" class="form-text">
      Enter the full URL to an image you'd like to use as the header-image for your story. (We use <a
        href="https://unsplash.com/" target="_blank">Unsplash</a> for our images.)
    </div>
    <div class="invalid-feedback">
      You must provide a header image for your story.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
  </div>
  <div class="form-floating col-md-12">
    <textarea id="input" required></textarea>
    <div class="invalid-feedback">
      You must provide a story.
    </div>
  </div>
  </FormGroup>
  <div class="form-floating col-md-8">
    <input type="email" class="form-control" id="emailInput" placeholder="name@example.com"
      aria-describedby="emailHelpBlock">
    <label for="emailInput">Email address</label>
    <div id="emailHelpBlock" class="form-text">
      You do <strong>not</strong> have to supply your email address. If you do, we will never share it with anyone else.
    </div>
  </div>
  <div class="form-floating col-md-4">
    <label for="twitterUsername" class="form-label">Twitter Handle</label>
    <div class="input-group has-validation">
      <span class="input-group-text" id="inputGroupPrepend">@</span>
      <input type="text" class="form-control" id="twitterUsername" aria-describedby="twitterUsernameHelpBlock">
      <div id="twitterUsernameHelpBlock" class="form-text">
        You do <strong>not</strong> have to supply your twitter handle. If you do, we will link your submission to your
        twitter account.
      </div>
    </div>
  </div>
  <div class="form-floating col-md-6">
    <input type="text" class="form-control" id="nameInput" placeholder="Your name or pseudonym"
      aria-describedby="nameHelpBlock" required>
    <label for="nameInput">Name or Pseudonym</label>
    <div id="nameHelpBlock" class="form-text">
      You do <strong>not</strong> have to supply your real name. Please feel free to use an anonymous pseudonym if you
      wish.
    </div>
    <div class="invalid-feedback">
      You must provide either your real name or a pseudonym before submitting.
    </div>
    <div class="valid-feedback">
      Looks good!
    </div>
  </div>
  <div class="form-floating col-md-6">
    <input type="url" class="form-control" id="webInput" placeholder="Your website" aria-describedby="webHelpBlock">
    <label for="webInput">Your website</label>
    <div id="webHelpBlock" class="form-text">
      You do <strong>not</strong> have to supply this. If you do, we will link your submission back to this address.
    </div>

  </div>
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <div class="form-floating col-md-8">
      <div class="form-check form-check-reverse">
        <input class="form-check-input" type="checkbox" value="getCOC()" id="reverseCheck1" onchange=checkCOC()>
        <label class="form-check-label" for="reverseCheck1">
          I have read and agree to the <a href="/code_of_conduct" target="_blank">Code of Conduct</a> and <a
            href="/privacy_policy" target="_blank">Privacy Policy</a>.
        </label>
        <div class="invalid-feedback">
          You must agree before submitting.
        </div>
        <div class="valid-feedback">
          Looks good!
        </div>
      </div>
    </div>
    <div class="form-floating col-md-2">
      <button id="submitButton" class="btn btn-primary me-md-2" type="submit" onClick=submitForm()
        disabled>Submit</button>
    </div>
    <div class="form-floating col-md-2">
      <button class="btn btn-danger" type="button" onClick=clearForm()>Clear</button>
    </div>
  </div>
</form>
<script>
  // (() => {
  //   'use strict'

  //   // Fetch all the forms we want to apply custom Bootstrap validation styles to
  //   const forms = document.querySelectorAll('.needs-validation')

  //   // Loop over them and prevent submission
  //   Array.from(forms).forEach(form => {
  //     form.addEventListener('submit', event => {
  //       if (!form.checkValidity()) {
  //         event.preventDefault()
  //         event.stopPropagation()
  //       }

  //       form.classList.add('was-validated')
  //     }, false)
  //   })
  // })()
  let coc = false;
  const easyMDE = new EasyMDE();
  function clearForm() {
    easyMDE.value('');
  }
  function onSubmit() {
    console.log("submitting");
  }

  document.getElementById("storyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const forms = document.querySelectorAll('.needs-validation')
    const title = document.getElementById("titleInput").value;
    const description = document.getElementById("descriptionInput").value;
    const image = document.getElementById("imageInput").value;
    const email = document.getElementById("emailInput").value;
    const twitter = document.getElementById("twitterUsername").value;
    const name = document.getElementById("nameInput").value;
    const web = document.getElementById("webInput").value;
    const content = easyMDE.value();
    const data = {
      title: title,
      description: description,
      image: image,
      email: email,
      twitter: twitter,
      name: name,
      web: web,
      content: content
    };
    console.log(data);
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://devreldiaries.com:9494/submitStory/", true);
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onload = () => console.log(xhr.responseText);
    xhr.send(data);
  });

  // function sendData(function (callback) {
  //   const httpTransport = require('https');
  //   const responseEncoding = 'utf8';
  //   const httpOptions = {
  //     hostname: 'devreldiaries.com',
  //     port: '9494',
  //     path: '/submitStory',
  //     method: 'POST',
  //         headers: { "Content-Type": "application/json; charset=utf-8" }
  //   };
  //   httpOptions.headers['User-Agent'] = 'node ' + process.version;
  //       // Paw Follow Redirects option is not supported
  //       // Paw Store Cookies option is not supported
  //   const request = httpTransport.request(httpOptions, (res) => {
  //     let responseBufs = [];
  //     let responseStr = '';
  //     res.on('data', (chunk) => {
  //       if (Buffer.isBuffer(chunk)) {
  //         responseBufs.push(chunk);
  //       }
  //       else {
  //         responseStr = responseStr + chunk;
  //       }
  //     }).on('end', () => {
  //       responseStr = responseBufs.length > 0 ?
  //         Buffer.concat(responseBufs).toString(responseEncoding) : responseStr;
  //         callback(null, res.statusCode, res.headers, responseStr);
  //     });
  //   })
  //     .setTimeout(0)
  //     .on('error', (error) => {
  //         callback(error);
  //     });
  //   request.write("{\"content\":\"This is my story\\u21b5\\u21b5### Part 3\\u21b5\\u21b5I'll stick to it.\",\"description\":\"Stick it\",\"email\":\"santafen@mac.com\",\"image\":\"image.jpg\",\"title\":\"My story\",\"twitter\":\"davidgsIoT\",\"web\":\"https://davidgs.com\",\"contents\":\"# My Story\\nThis is my story\\n## Sticking it\\nI'm sticking to it.\"}");
  //   request.end();
  // }) ((error, statusCode, headers, body) => {
  //       console.log('ERROR:', error);
  //       console.log('STATUS:', statusCode);
  //       console.log('HEADERS:', JSON.stringify(headers));
  //       console.log('BODY:', body);
  //   });
  // }
  function checkCOC() {
    if (coc) {
      coc = false;
    } else {
      coc = true;
    }
    console.log(coc);
    if (coc) {
      document.getElementById("submitButton").removeAttribute("disabled");
    } else {
      document.getElementById("submitButton").setAttribute("disabled", "disabled");
    }
  }
</script>